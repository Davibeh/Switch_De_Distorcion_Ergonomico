/*
 * Echo.c
 *
 *  Created on: Mar 24, 2018
 *      Author: Edgar Padilla Chung
 *
  *---------------------------------------------------------
 * Change History
 * --------------------------------------------------------
 * Name: David Roberto Bellomo Gomez
 * Date: 31/03/18
 * Description: Alfa variant integration to the Beta variant:
 * 				1- Remove the check for the PIT flag, now this task is executed at interrupt level.
 * 				2- New managed of the ADC conversion, now the conversion is triggered and a wait for complete retains the core
 * 				3- Cleaning the code
 * * --------------------------------------------------------
 */

#include "Echo.h"

#define RESET                                 0

#define MAX_NUMBER     						  4090
	

static unsigned short wOffsetDAC = MAX_NUMBER;

static unsigned short wOffsetADC = RESET;

static unsigned short wArray[4096] = {0};

static unsigned short *PtrArray = wArray;

static unsigned short wAdcData;

unsigned char ADC_Inconverstion = 0x00u;




void vfnEcho (void)
{


	    app_ADC_Trigger(APP_ADC_CHANNEL); /*Trigger the ADC channel conversion*/
	    while(ADC_ConvertioCheck(ADC_CHANNEL) != TRUE); /*This might be very dangerous. Need to determine if we may need to implement a timeout stategy*/

		if (ADC_ConvertioCheck(ADC_CHANNEL))
		{
			ADC_Inconverstion = 0x00u;
			wAdcData = ADC_wfnLecture();

			*(PtrArray+wOffsetADC) = wAdcData;

			DAC_vfnDisplay((wAdcData + *(PtrArray+wOffsetDAC))/2);

			if (wOffsetADC == RESET )
			{
				wOffsetADC = MAX_NUMBER;
			}

			else
			{
				wOffsetADC--;
			}
			if (wOffsetDAC == RESET )
			{
				wOffsetDAC = MAX_NUMBER;
			}
			else
			{
				wOffsetDAC--;
			}

}
